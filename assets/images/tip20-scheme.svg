<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 850 520" width="850" height="520">
  <defs>
    <linearGradient id="blueGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#3498db;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#2980b9;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="greenGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#27ae60;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#1e8449;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="purpleGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#9b59b6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#7d3c98;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="orangeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#e67e22;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#d35400;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="tealGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#1abc9c;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#16a085;stop-opacity:1" />
    </linearGradient>
    <marker id="arrowBlue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#2980b9"/>
    </marker>
    <marker id="arrowBlueLarge" markerWidth="12" markerHeight="12" refX="10" refY="4" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,8 L12,4 z" fill="#2980b9"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#27ae60"/>
    </marker>
    <marker id="arrowPurple" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#9b59b6"/>
    </marker>
    <marker id="arrowOrange" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#e67e22"/>
    </marker>
    <marker id="arrowGray" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#7f8c8d"/>
    </marker>
    <marker id="arrowTeal" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#16a085"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="850" height="520" fill="#fafafa"/>

  <!-- Title -->
  <text x="425" y="35" text-anchor="middle" font-family="Arial, sans-serif" font-size="20" font-weight="bold" fill="#2c3e50">TIP20: メタデータ紐付けスキーム</text>

  <!-- Step 1: Metadata + Base Pubkey -->
  <g transform="translate(100, 70)">
    <!-- JSON Metadata box -->
    <rect x="0" y="0" width="140" height="100" rx="8" fill="url(#blueGrad)"/>
    <text x="70" y="30" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="#fff">JSON Metadata</text>
    <text x="70" y="50" text-anchor="middle" font-family="monospace" font-size="10" fill="#fff">{"name": "Token",</text>
    <text x="70" y="65" text-anchor="middle" font-family="monospace" font-size="10" fill="#fff">"symbol": "TKN",</text>
    <text x="70" y="80" text-anchor="middle" font-family="monospace" font-size="10" fill="#fff">...}</text>
  </g>

  <g transform="translate(100, 190)">
    <!-- Base Public Key box -->
    <rect x="0" y="0" width="140" height="60" rx="8" fill="url(#greenGrad)"/>
    <text x="70" y="25" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="#fff">Base Public Key</text>
    <text x="70" y="45" text-anchor="middle" font-family="monospace" font-size="9" fill="#fff">02abc...def</text>
  </g>

  <!-- Arrow from Metadata to P2C calculation -->
  <path d="M245,120 L300,160" stroke="#2980b9" stroke-width="2" fill="none" marker-end="url(#arrowBlue)"/>
  <!-- Arrow from Base Pubkey to P2C calculation -->
  <path d="M245,220 L300,180" stroke="#27ae60" stroke-width="2" fill="none" marker-end="url(#arrowGreen)"/>

  <!-- P2C Calculation -->
  <g transform="translate(305, 135)">
    <rect x="0" y="0" width="130" height="90" rx="8" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="2"/>
    <text x="65" y="25" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#2c3e50">P2C 導出</text>
    <text x="65" y="45" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#7f8c8d">P2C_pubkey =</text>
    <text x="65" y="60" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#7f8c8d">Base + H(Meta)</text>
    <text x="65" y="80" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#7f8c8d">× G</text>
  </g>

  <!-- Arrow to Funding Tx -->
  <path d="M440,180 L490,180" stroke="#7f8c8d" stroke-width="2" fill="none" marker-end="url(#arrowGray)"/>

  <!-- Funding Transaction -->
  <g transform="translate(495, 120)">
    <rect x="0" y="0" width="140" height="120" rx="8" fill="url(#purpleGrad)"/>
    <text x="70" y="25" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#fff">Funding Tx</text>
    <line x1="10" y1="38" x2="130" y2="38" stroke="#fff" stroke-width="1" opacity="0.3"/>
    <text x="70" y="58" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#fff">Output:</text>
    <text x="70" y="75" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#fff">P2C Address</text>
    <rect x="20" y="88" width="100" height="22" rx="3" fill="url(#tealGrad)"/>
    <text x="70" y="103" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#fff">OutPoint</text>
  </g>

  <!-- Arrow to Issue Tx -->
  <path d="M565,245 L565,275" stroke="#9b59b6" stroke-width="2" fill="none" marker-end="url(#arrowPurple)"/>
  <text x="580" y="265" font-family="Arial, sans-serif" font-size="9" fill="#7f8c8d">参照</text>

  <!-- Issue Transaction -->
  <g transform="translate(450, 280)">
    <rect x="0" y="0" width="230" height="90" rx="8" fill="#2c3e50"/>
    <text x="115" y="22" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="#fff">発行トランザクション</text>
    <line x1="15" y1="35" x2="215" y2="35" stroke="#fff" stroke-width="1" opacity="0.3"/>
    <text x="65" y="53" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#9b59b6">Input:</text>
    <text x="65" y="70" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#fff">P2C UTXO</text>
    <text x="170" y="53" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#e67e22">Output:</text>
    <text x="170" y="70" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#fff">Colored Coin</text>
  </g>

  <!-- Arrow to Color ID -->
  <path d="M685,325 L730,325" stroke="#e67e22" stroke-width="2" fill="none" marker-end="url(#arrowOrange)"/>

  <!-- Color ID -->
  <g transform="translate(735, 285)">
    <rect x="0" y="0" width="100" height="80" rx="8" fill="url(#orangeGrad)"/>
    <text x="50" y="28" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#fff">Color ID</text>
    <text x="50" y="48" text-anchor="middle" font-family="monospace" font-size="9" fill="#fff">c1abc...</text>
    <text x="50" y="68" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#fff">(トークン識別子)</text>
  </g>

  <!-- Cryptographic link indicator -->
  <g transform="translate(100, 290)">
    <rect x="0" y="0" width="160" height="45" rx="5" fill="#fff" stroke="#27ae60" stroke-width="2" stroke-dasharray="5,3"/>
    <text x="80" y="18" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#27ae60">暗号学的に紐付け</text>
    <text x="80" y="35" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#7f8c8d">Metadata ↔ Color ID</text>
  </g>
  <!-- Line from Metadata to cryptographic link box (routed left to avoid Base Pubkey) -->
  <path d="M100,145 L80,145 L80,290 L100,290" stroke="#27ae60" stroke-width="1.5" stroke-dasharray="4,2" fill="none"/>
  <!-- Line from cryptographic link box to Issue Tx -->
  <path d="M260,312 L445,330" stroke="#27ae60" stroke-width="1.5" stroke-dasharray="4,2" fill="none"/>

  <!-- Token Registry Section -->
  <g transform="translate(75, 400)">
    <rect x="0" y="0" width="700" height="105" rx="10" fill="#fff" stroke="#3498db" stroke-width="2"/>
    <text x="350" y="25" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="#2c3e50">Token Registry (オプション)</text>

    <!-- Registry box -->
    <g transform="translate(150, 40)">
      <rect x="0" y="0" width="260" height="55" rx="5" fill="#3498db"/>
      <text x="130" y="22" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#fff">tapyrus-token-registry</text>
      <text x="130" y="42" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#fff">メタデータを検証可能な形式で公開・共有</text>
    </g>

    <!-- Wallets group -->
    <g transform="translate(480, 40)">
      <rect x="0" y="0" width="180" height="55" rx="5" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="1"/>
      <text x="90" y="22" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#2c3e50">各種ウォレット</text>
      <text x="90" y="42" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#7f8c8d">Wallet A, B, C ...</text>
    </g>

    <!-- Single thick arrow from registry to wallets -->
    <path d="M415,67 L475,67" stroke="#3498db" stroke-width="3" fill="none" marker-end="url(#arrowBlueLarge)"/>
  </g>

  <!-- Arrows from source data to Token Registry (all routed through left side) -->
  <!-- From JSON Metadata - go left and down -->
  <path d="M100,120 L50,120 L50,450 L75,450" stroke="#3498db" stroke-width="1.5" stroke-dasharray="5,3" fill="none" marker-end="url(#arrowBlue)"/>

  <!-- From Base Pubkey - go left and down -->
  <path d="M100,220 L35,220 L35,465 L75,465" stroke="#27ae60" stroke-width="1.5" stroke-dasharray="5,3" fill="none" marker-end="url(#arrowGreen)"/>

  <!-- From OutPoint - go left around everything and down -->
  <path d="M495,220 L475,220 L475,260 L20,260 L20,480 L75,480" stroke="#16a085" stroke-width="1.5" stroke-dasharray="5,3" fill="none" marker-end="url(#arrowTeal)"/>
</svg>
